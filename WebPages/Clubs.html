<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>Clubs</title>
        <link href='https://fonts.googleapis.com/css?family=Lemon' rel='stylesheet'>
        <link rel="shortcut icon" href="../Images/Logo.svg" type="image/x-icon"/>
        <link rel="stylesheet" href="../BooksHub/CSS/Books_Hub.css"/>
      </head>
<body>
    
<!-- PRELOADER -->
<div id="preloader">
</div>

<!-- NavBar -->
<nav class="navbar">
  <div class="logo">
    <a href="../index.html">
      <img src="../Images/Logo.svg" alt="navlog"/>
    </a>
  </div>
  <button class="menu-toggle">
   <img src="../Images/Toggle.svg">
  </button>
  <ul class="nav-links">
    <li><a href="../index.html" target="_blank">Home</a></li>
    <li><a href="../BooksHub-HtmlFiles/books.html" target="_blank">Books</a></li>
    <li><a href="../BooksHub-HtmlFiles/contact.html" target="_blank">Contact</a></li>
    <li><a href="../BooksHub-HtmlFiles/books.html" target="_blank">About</a></li>
    <li><a href="../BooksHub-HtmlFiles/donatetion.html" target="_blank">Donate</a></li>
    <li><a href="../BooksHub-HtmlFiles/Clubs.html">Club</a></li>
  </ul>
  <a href="https://forms.gle/7HaYL5PqKcEMPyv6A" target="_blank" class="E-BookSub">Submit Your E-Book</a>
</nav>

<img src="../Images/GroupBack.svg" style="display: flex; position: absolute; height: 100vh; width: 100vw; filter: brightness(0.5);" id="grpchatbackimg">

<div id="chat"></div>
<form id="messageForm">
    <input type="text" id="messageInput" placeholder="Join the joyous conversation about books..." />
    <button type="button" id="sendButton"><img src="../Images/SendIcon.png" style="position: absolute; height: 50px; left: 0px; top: -15px;"></button>
    <input type="text" id="emojiInput" placeholder="Pick an emoji..." style="display: none;" />
    <emoji-picker for="emojiInput" style="position: fixed;height: 300px;top: 53.5%;left: 75.7%;" hidden></emoji-picker>
</form>

<div id="authSection">
    <button type="button" id="googleSignInButton"> <img src="../Images/Google.svg.svg"> Sign In with Google</button>
</div>

<button id="emoji"> ðŸ™‚ </button>

<!-- Updated ID for the pop-up message -->
<div id="reloadPopup" style="display: none;">
  <p>Successfully signed in! Please reload the page to see the messages.</p>
  <button onclick="reloadPage()">Reload Page</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-analytics.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyBDU59Z9OIT2Lgc7OUJCYTiTFsFZKGhOeo",
        authDomain: "bookshubclub.firebaseapp.com",
        databaseURL: "https://bookshubclub-default-rtdb.firebaseio.com",
        projectId: "bookshubclub",
        storageBucket: "bookshubclub.appspot.com",
        messagingSenderId: "415391273038",
        appId: "1:415391273038:web:49a087a7ec3563d849331f",
        measurementId: "G-4KEKBJ1B6D"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase(app);
    const messagesRef = ref(database, 'messages');

    const authSection = document.getElementById('authSection');
    const googleSignInButton = document.getElementById('googleSignInButton');
    const sendButton = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');

    let currentUser = null;
    let messagesLoaded = false;

    // Function to reload the page
function reloadPage() {
    location.reload();
}

googleSignInButton.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();

    try {
        const result = await signInWithPopup(auth, provider);
        console.log("Sign-in success:", result);
        currentUser = result.user;
        authSection.style.display = 'none';

        // Show the reload pop-up
        document.getElementById('reloadPopup').style.display = 'block';
    } catch (error) {
        console.error("Sign-in error:", error.message);
    }
});

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            authSection.style.display = 'none';
            messageInput.removeAttribute('disabled');
            sendButton.removeAttribute('disabled');
        } else {
            currentUser = null;
            authSection.style.display = 'block';
            messageInput.setAttribute('disabled', 'disabled');
            sendButton.setAttribute('disabled', 'disabled');
        }
    });

    sendButton.addEventListener('click', () => {
        const user = currentUser ? currentUser.displayName : "Anonymous";

        if (messageInput.value.trim() !== '') {
            push(messagesRef, {
                user: user,
                userImage: currentUser ? currentUser.photoURL : null,
                text: messageInput.value,
                timestamp: new Date().toISOString(),
            });
            messageInput.value = '';
        }
    });

    function displayMessage(message) {
        const chat = document.getElementById('chat');
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        const userImage = document.createElement('img');
        userImage.src = message.userImage || 'default-user-image.jpg';
        userImage.alt = 'User Image';
        userImage.classList.add('user-image');
        messageContainer.appendChild(userImage);

        const messageContent = document.createElement('div');
        messageContent.classList.add('message-content');

        const userName = document.createElement('span');
        userName.classList.add('user-name');
        userName.textContent = message.user;
        messageContent.appendChild(userName);

        const messageText = document.createElement('p');
        messageText.innerHTML = linkify(message.text);
        messageContent.appendChild(messageText);

        messageContainer.appendChild(messageContent);

        if (message.user === currentUser?.displayName) {
            messageContainer.classList.add('right-message');
            messageContainer.style.left = '0%'; 
            messageContainer.style.position = 'relative'; 
            messageContainer.style.maxWidth = '500px'; 
        } else {
            messageContainer.classList.add('left-message');
            messageContainer.style.maxWidth = '500px';
        }

        chat.appendChild(messageContainer);
        chat.scrollTop = chat.scrollHeight;
    }

    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`);
    }

    function applyMessageStyles() {
        if (!messagesLoaded) {
            return;
        }

        const messages = document.querySelectorAll('.message-container');
        messages.forEach((message) => {
            if (message.classList.contains('right-message')) {
                message.style.justifyContent = 'flex-end';

            } else if (message.classList.contains('left-message')) {
                message.style.justifyContent = 'flex-start';
            }
        });
    }

    onValue(messagesRef, (snapshot) => {
        const chat = document.getElementById('chat');
        chat.innerHTML = '';

        const messages = snapshot.val();
        for (const key in messages) {
            displayMessage(messages[key]);
        }

        messagesLoaded = true;
        applyMessageStyles();
    });

    document.addEventListener('DOMContentLoaded', () => {
        const emojiInput = document.getElementById('emojiInput');
        const emojiPickerButton = document.getElementById('emoji');
        const emojiPicker = document.querySelector('emoji-picker');

        emojiPickerButton.addEventListener('click', () => {
            emojiPicker.hidden = !emojiPicker.hidden;
            emojiInput.focus();
        });

        emojiPicker.addEventListener('emoji-click', (event) => {
            const emoji = event.detail.unicode;
            messageInput.value += emoji;
        });
    });
</script>
<script type="module" src="https://unpkg.com/emoji-picker-element"></script>

<script src="../BooksHub/JS/Books_Hub.js"></script>
</body>
</html>